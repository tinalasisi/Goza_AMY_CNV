---
title: "Analysis v2"
author: "Tina Lasisi"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r setup, echo=FALSE, message=FALSE, warning=FALSE}

library(readxl)
library(ggplot2)
library(ggridges)
library(ggpubr)
library(ggfortify)
library(corrplot)
library(factoextra)
library(GGally)
library(mediation)
library(lavaan)
library(tidyverse)


knitr::opts_chunk$set(
	fig.height = 6,
	fig.width = 7,
	message = FALSE,
	warning = FALSE,
	results = "markup"
)
```

## Clusters


```{r import-data}

df_saliva <- read_csv("data/df_saliva.csv") %>% 
  rename(TP_Before_1 = Total_Protein_Before_1_ug_mL,
         TP_Before_2 = Total_Protein_Before_2_ug_mL,
         TP_After_1 = Total_Protein_After_1_ug_mL,
         TP_After_2 = Total_Protein_After_2_ug_mL,
         sAA_Before = sAA_Mean_Collection_Before_U_mL,
         sAA_After = sAA_Mean_Collection_After_U_mL,
         TP_Before = Total_Protein_Before_Mean_ug_mL,
         TP_After = Total_Protein_Mean_After_ug_mL)
```

First, we will do a PCA using genetic and protein variables to see if there are any clusters in our dataset.

```{r var-include}

vars_include <- c("Primer1_Diploid", "Primer2_Diploid", "TP_Before_1", "TP_Before_2", "TP_After_1", "TP_After_2", "TP_Change", "sAA_Before", "sAA_After", "sAA_Change", "Weight_Saliva_g_1", "Weight_Saliva_g_2", "Flow_Rate_1_g_min", "Flow_Rate_2_g_min", "Sample_ID")

```


### NA values omitted
We will do the analysis first by omitting na values.
```{r df-pca-na-omit}

# Scale the Data
df_saliva_scaled <- df_saliva %>%
  select(all_of(vars_include)) %>% 
  select(-Sample_ID) %>% 
  na.omit() %>% 
  mutate(across(everything(), ~ as.numeric(.) %>% scale))

# Data unscaled
df_saliva_unscaled <- df_saliva %>%
  select(all_of(vars_include)) %>% 
  select(-"Sample_ID") %>% 
  na.omit()

# Perform PCA
pca <- df_saliva_scaled %>%
  prcomp(center = FALSE, scale. = FALSE)

# Print the summary of the PCA object
summary(pca)


```

```{r cor-matrix-na-omit}
# Compute a correlation matrix
cor.matrix <- cor(df_saliva_scaled)

# Create a correlation heatmap 
corrplot(cor.matrix, method = "color", type = "upper", tl.cex = .7, insig = "blank")

corrplot(cor.matrix, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, tl.cex = .7, insig = "blank")
```

```{r scree-na-omit}
# Scree plot of variances
fviz_eig(pca)

```

```{r contrib-na-omit}
# Plot the variable factors 
fviz_pca_var(pca, col.var="contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)

```

### NA replaced with mean
We repeat the analysis with means replacing missing values.
```{r df-pca-na-mean}

# Scale the Data
df_saliva_scaled <- df_saliva %>%
  select(all_of(vars_include)) %>% 
  select(-"Sample_ID") %>% 
  # na.omit() %>% 
  mutate(across(everything(), ~ replace(., is.na(.), mean(., na.rm = TRUE)))) %>%
    mutate(across(everything(), ~ as.numeric(.) %>% scale))


# Perform PCA
pca <- df_saliva_scaled %>%
  prcomp(center = FALSE, scale. = FALSE)

# Print the summary of the PCA object
summary(pca)
```


```{r cor-matrix-na-mean}
# Compute a correlation matrix
cor.matrix <- cor(df_saliva_scaled)

# Create a correlation heatmap 
corrplot(cor.matrix, method = "color", type = "upper", tl.cex = .7, insig = "blank")

corrplot(cor.matrix, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, tl.cex = .7, insig = "blank")
```

```{r scree-na-mean}
# Scree plot of variances
fviz_eig(pca)

```

```{r contrib-na-mean}
# Plot the variable factors 
fviz_pca_var(pca, col.var="contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)

```

### Reduced variable PCA
In both cases, it appears as though it would be sufficient to take the following variables as they are highly correlated in the same directions (or a summary value representing both)
And we will add two combined flowrate sAA values based on the sAA after and before, and change.

```{r df-saliva-final}

# Let's ensure ID column is a factor
df_saliva$Sample_ID <- as.factor(df_saliva$Sample_ID)

# Save your non-numeric variable
df_label <- df_saliva$Sample_ID
starch_freq <- df_saliva$Starch_Frequency
citrus_length <- df_saliva$Citrus_Sum_120sec

df_saliva_final <- df_saliva %>% 
  mutate(Flow_Rate_mean = (Flow_Rate_1_g_min + Flow_Rate_2_g_min)/2,
         sAA_flow_After = sAA_After*Flow_Rate_mean,
         sAA_flow_Before = sAA_Before*Flow_Rate_mean,
         sAA_flow_Change = sAA_Change*Flow_Rate_mean) %>% 
  select(TP_Before, TP_After, Primer1_Diploid, Primer2_Diploid, TP_Change, sAA_Change, sAA_Before, sAA_After, Flow_Rate_mean, sAA_flow_Before, sAA_flow_After, sAA_flow_Change, Starch_Frequency, Citrus_Sum_120sec)

```

```{r df-saliva-final-scale}
# Scale your numeric data and store original row names
  
scaled_df <- df_saliva_final %>% 
  na.omit() %>% 
  mutate(across(everything(), ~ replace(., is.na(.), mean(., na.rm = TRUE)))) %>%
  mutate(across(everything(), ~scale(.x)))  

# Save the original order of your data
row_order <- row.names(scaled_df)
```


```{r df-final-pca}
# Perform PCA
pca_results <- prcomp(scaled_df, center = FALSE, scale = FALSE)

# Print the summary of the PCA object
summary(pca_results)

# Add original row names back to the scores. 
rownames(pca_results$x) <- row_order

# Add Starch_Frequency back as a factor 
df_final <- data.frame(pca_results$x, Starch_Frequency = starch_freq[match(row_order, df_label)])



```

```{r contrib-na-mean-final}
# Plot the variable factors 
fviz_pca_var(pca_results, col.var="contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)

```
#### Starch Frequency PCA

```{r df-final-contrib-starch}
fviz_pca_ind(pca_results, 
             label = "none", 
             habillage = df_final$Starch_Frequency, 
             addEllipses = TRUE,
             palette = "jco",
             legend.title = "Starch Frequency")
```


#### CNV gradient PCA
```{r fig-final-pca-gradient}
# Before adding `Primer2_Diploid` variable to our new dataframe, ensure it's numeric
df_final$Primer2_Diploid <- as.numeric(df_saliva$Primer2_Diploid[match(row_order, df_label)])

# Plot the PCA scores
ggplot(df_final, aes(x = PC1, y = PC2)) + 
  geom_point(aes(color = Primer2_Diploid)) + 
  scale_color_gradient(low = "blue", high = "green") +
  theme_minimal() +
  labs(color = "Primer2_Diploid levels")





```


#### Citrus gradient PCA
```{r fig-final-pca-gradient-citrus}
# Before adding `Citrus_Sum_120sec` variable to our new dataframe, ensure it's numeric
df_final$Citrus_Sum_120sec <- as.numeric(df_saliva$Citrus_Sum_120sec[match(row_order, df_label)])

# Plot the PCA scores
ggplot(df_final, aes(x = PC1, y = PC2)) + 
  geom_point(aes(color = Citrus_Sum_120sec)) + 
  scale_color_gradient(low = "blue", high = "green") +
  theme_minimal() +
  labs(color = "Citrus Length")



```


```{r fig-scatter-matrix-pearson, fig.cap="Pearson's correlation", fig.width=10, fig.height=10}

# Select only numeric columns
df_numeric <- df_saliva_final[, sapply(df_saliva_final, is.numeric)]

# Create the scatter plot matrix
ggpairs(df_numeric)

```

```{r fig-scatter-matrix-spearman, fig.cap="Spearman's rank correlation", fig.width=10, fig.height=10}
# Create the scatter plot matrix using spearman correlation
ggpairs(df_numeric, upper = list(continuous = wrap("cor", method = "spearman")))

```

## Relationship between CNV, protein and sAA

```{r df-med}
df_saliva_lm <- df_saliva %>% 
  mutate(Flow_Rate_mean = (Flow_Rate_1_g_min + Flow_Rate_2_g_min)/2,
         sAA_flow_After = sAA_After*Flow_Rate_mean,
         sAA_flow_Before = sAA_Before*Flow_Rate_mean,
         sAA_flow_Change = sAA_Change*Flow_Rate_mean) %>% 
  select(TP_Before, TP_After, Primer1_Diploid, Primer2_Diploid, TP_Change, sAA_Change, sAA_Before, sAA_After, Flow_Rate_mean, sAA_flow_Before, sAA_flow_After, sAA_flow_Change, Starch_Frequency, Citrus_Sum_120sec) %>% 
  na.omit()
  
```

### Mediator models

```{r func-med-model}
# Generalized function to toggle different timepoints or changes
run_mediation_model_Primer2 <- function(df, timepoint_or_change) {
    mediation_model <- paste("
        # direct effect
        sAA_", timepoint_or_change, " ~ c*Primer2_Diploid
        # mediator
        Flow_Rate_mean ~ a*Primer2_Diploid
        TP_", timepoint_or_change, " ~ m*Primer2_Diploid
        sAA_", timepoint_or_change, " ~ b*Flow_Rate_mean + n*TP_", timepoint_or_change, "
        # indirect effect (a*b and m*n)
        indirect1 := a*b
        indirect2 := m*n
        # total effect
        total := c + (a*b) + (m*n)
     ", sep="")

    # Fit the model
    fit <- sem(mediation_model, data=df)

    # Return the model
    return(fit)
}

run_mediation_model_Primer1 <- function(df, timepoint_or_change) {
    mediation_model <- paste("
        # direct effect
        sAA_", timepoint_or_change, " ~ c*Primer1_Diploid
        # mediator
        Flow_Rate_mean ~ a*Primer1_Diploid
        TP_", timepoint_or_change, " ~ m*Primer1_Diploid
        sAA_", timepoint_or_change, " ~ b*Flow_Rate_mean + n*TP_", timepoint_or_change, "
        # indirect effect (a*b and m*n)
        indirect1 := a*b
        indirect2 := m*n
        # total effect
        total := c + (a*b) + (m*n)
     ", sep="")

    # Fit the model
    fit <- sem(mediation_model, data=df)

    # Return the model
    return(fit)
}

run_mediation_model_Primer1_sAA_flow_TP_mediator <- function(df, timepoint_or_change) {
    mediation_model <- paste("
        # direct effect
        sAA_flow_", timepoint_or_change, " ~ c*Primer1_Diploid
        # mediator
        TP_", timepoint_or_change, " ~ a*Primer1_Diploid
        sAA_flow_", timepoint_or_change, " ~ b*TP_", timepoint_or_change, "
        # indirect effect (a*b)
        indirect1 := a*b
        # total effect
        total := c + (a*b)
     ", sep="")

    # Fit the model
    fit <- sem(mediation_model, data=df)

    # Return the model
    return(fit)
}

run_mediation_model_Primer2_sAA_flow_TP_mediator <- function(df, timepoint_or_change) {
    mediation_model <- paste("
        # direct effect
        sAA_flow_", timepoint_or_change, " ~ c*Primer2_Diploid
        # mediator
        TP_", timepoint_or_change, " ~ a*Primer2_Diploid
        sAA_flow_", timepoint_or_change, " ~ b*TP_", timepoint_or_change, "
        # indirect effect (a*b)
        indirect1 := a*b
        # total effect
        total := c + (a*b)
     ", sep="")

    # Fit the model
    fit <- sem(mediation_model, data=df)

    # Return the model
    return(fit)
}



library(semPlot)

plot_sem_model <- function(model) {
  # create the plot
  semPaths(model, 
           "std", # standardized coefficients
           "est", # show estimates
           curveAdjacent = TRUE, # curved lines for better distinction of paths
           style = "lisrel") # style of the plot
}


```

#### CNV to sAA with mediator TP and Flow rate

##### Before

```{r med-model-before}

# Run the mediation model for Primer1
fit_before_P1 <- run_mediation_model_Primer1(df_saliva_lm, 'Before')
# Summarize the results
cat("Summary for Primer1 Model:\n")
summary(fit_before_P1)

# Run the mediation model for Primer2
fit_before_P2 <- run_mediation_model_Primer2(df_saliva_lm, 'Before')
# Summarize the results
cat("\n\nSummary for Primer2 Model:\n")
summary(fit_before_P2)

```


```{r fig-med-before, fig.cap="Mediator models for values before experiment"}

layout(matrix(1:2, nrow = 1, byrow = TRUE))
# Tags/labels for each plot
layout_title <- c("Primer 1", "Primer 2")

# Create the first plot
plot_sem_model(fit_before_P1)
title(layout_title[1])

# Create the second plot
plot_sem_model(fit_before_P2)
title(layout_title[2])

```


##### After
```{r med-model-after}


# Run the mediation model for Primer1
fit_after_P1 <- run_mediation_model_Primer1(df_saliva_lm, 'After')
# Summarize the results
cat("Summary for Primer1 Model:\n")
summary(fit_after_P1)

# Run the mediation model for Primer2
fit_after_P2 <- run_mediation_model_Primer2(df_saliva_lm, 'After')
# Summarize the results
cat("\n\nSummary for Primer2 Model:\n")
summary(fit_after_P2)



```


```{r fig-med-after, fig.cap="Mediator model for values after experiment"}


# Set up layout
layout(matrix(1:2, nrow = 1, byrow = TRUE))
# Tags/labels for each plot
layout_title <- c("Primer 1", "Primer 2")

# Create the first plot
plot_sem_model(fit_after_P1)
title(layout_title[1])

# Create the second plot
plot_sem_model(fit_after_P2)
title(layout_title[2])


```

##### Change
```{r med-model-change}


# Run the mediation model for Primer1
fit_change_P1 <- run_mediation_model_Primer1(df_saliva_lm, 'Change')
# Summarize the results
cat("Summary for Primer1 Model:\n")
summary(fit_change_P1)

# Run the mediation model for Primer2
fit_change_P2 <- run_mediation_model_Primer2(df_saliva_lm, 'Change')
# Summarize the results
cat("\n\nSummary for Primer2 Model:\n")
summary(fit_change_P2)


```


```{r fig-med-change, fig.cap="Mediator model for values changed during experiment"}


# set up layout 
layout(matrix(1:2, nrow = 1, byrow = TRUE))
# Tags/labels for each plot
layout_title <- c("Primer 1", "Primer 2")

# Create the first plot
plot_sem_model(fit_change_P1)
title(layout_title[1])

# Create the second plot
plot_sem_model(fit_change_P2)
title(layout_title[2])


```

#### CNV to sAA*flow with TP mediator

##### Before
```{r}

# Run the mediation model for Primer1
fit_before_sAA_flow_Primer1 <- run_mediation_model_Primer1_sAA_flow_TP_mediator(df_saliva_lm, 'Before')
# Summarize the results
cat("Summary for Primer1 Model:\n")
summary(fit_before_sAA_flow_Primer1)

# Run the mediation model for Primer2
fit_before_sAA_flow_Primer2 <- run_mediation_model_Primer2_sAA_flow_TP_mediator(df_saliva_lm, 'Before')
# Summarize the results
cat("\n\nSummary for Primer2 Model:\n")
summary(fit_before_sAA_flow_Primer2)


```

```{r}

layout(matrix(1:2, nrow = 1, byrow = TRUE))
# Tags/labels for each plot
layout_title <- c("sAA Flow Primer 1 - Before", "sAA Flow Primer 2 - Before")

# Create the first plot
plot_sem_model(fit_before_sAA_flow_Primer1)
title(layout_title[1])

# Create the second plot
plot_sem_model(fit_before_sAA_flow_Primer2)
title(layout_title[2])


```


##### After

```{r}

# Run the mediation model for Primer1
fit_after_sAA_flow_Primer1 <- run_mediation_model_Primer1_sAA_flow_TP_mediator(df_saliva_lm, 'After')
# Summarize the results
cat("Summary for Primer1 Model:\n")
summary(fit_after_sAA_flow_Primer1)

# Run the mediation model for Primer2
fit_after_sAA_flow_Primer2 <- run_mediation_model_Primer2_sAA_flow_TP_mediator(df_saliva_lm, 'After')
# Summarize the results
cat("\n\nSummary for Primer2 Model:\n")
summary(fit_after_sAA_flow_Primer2)


```


##### Change

```{r}

# Run the mediation model for Primer1
fit_change_sAA_flow_Primer1 <- run_mediation_model_Primer1_sAA_flow_TP_mediator(df_saliva_lm, 'Change')
# Summarize the results
cat("Summary for Primer1 Model:\n")
summary(fit_change_sAA_flow_Primer1)

# Run the mediation model for Primer2
fit_change_sAA_flow_Primer2 <- run_mediation_model_Primer2_sAA_flow_TP_mediator(df_saliva_lm, 'Change')
# Summarize the results
cat("\n\nSummary for Primer2 Model:\n")
summary(fit_change_sAA_flow_Primer2)


```

```{r}

layout(matrix(1:2, nrow = 1, byrow = TRUE))
# Tags/labels for each plot
layout_title <- c("sAA Flow Primer 1 - Change", "sAA Flow Primer 2 - Change")

# Create the first plot
plot_sem_model(fit_change_sAA_flow_Primer1)
title(layout_title[1])

# Create the second plot
plot_sem_model(fit_change_sAA_flow_Primer2)
title(layout_title[2])


```


## Relationship between CNV, sAA, and citrus perception

### Mediator models

```{r}
# Generalized function for mediation model including Flow_Rate_mean
run_citrus_model <- function(df, timepoint_or_change) {
  mediation_model <- paste("
    # direct effect
    Citrus_Sum_120sec ~ c*Primer2_Diploid
    # mediators
    sAA_", timepoint_or_change, " ~ a*Primer2_Diploid
    Flow_Rate_mean ~ m*Primer2_Diploid
    Citrus_Sum_120sec ~ b*sAA_", timepoint_or_change, " + n*Flow_Rate_mean
    # indirect effects (a*b and m*n)
    indirect1 := a*b
    indirect2 := m*n
    # total effect
    total := c + (a*b) + (m*n)
  ", sep="")
  

  # Fit the model
  fit <- sem(mediation_model, data=df)

  # Return the model
  return(fit)
}

```


#### Before

```{r}
citrus_model_before <- run_citrus_model(df_saliva_lm, 'Before')

summary(citrus_model_before)
```

```{r}
plot_sem_model(citrus_model_before)
```


#### After
```{r}
citrus_model_after <- run_citrus_model(df_saliva_lm, 'After')

summary(citrus_model_after)
```

```{r}
plot_sem_model(citrus_model_after)
```


#### Change
```{r}
citrus_model_change <- run_citrus_model(df_saliva_lm, 'Change')

summary(citrus_model_change)
```

```{r}
plot_sem_model(citrus_model_change)
```


## Flavor perception
```{r}
df_flavor <- read_csv("data/df_flavor.csv")
```

```{r}

data_long <- df_flavor %>%
  select(-c(Blinding_Code, Sample_Position)) %>%
  pivot_longer(cols = starts_with("time_"),
               names_to = "Time",
               names_prefix = "time_", 
               values_to = "Value") %>%
  mutate(Time = as.numeric(str_remove(Time, "s")),
         Sample_ID = as.factor(Sample_ID),
         Sample_Name = ifelse(Sample_Name == "Starch-Limonene Inclusion Complex",
                                "Starch-Limonene IC",
                                Sample_Name),
         Sample_Name = as.factor(Sample_Name),
         Attribute = as.factor(Attribute))


```

```{r}
data_summary <- data_long %>%
  group_by(Sample_Name, Attribute) %>%
  summarise(mean = mean(Value, na.rm = TRUE),
            sd = sd(Value, na.rm = TRUE),
            .groups = "drop")  # drop grouping afterwards

```

```{r}
data_summary <- data_long %>%
  group_by(Sample_Name, Attribute, Time) %>%
  summarise(mean_value = mean(Value, na.rm = TRUE), .groups = "drop")


ggplot(data_summary, aes(x = Time, y = mean_value, color = Attribute)) +
  geom_line() +
  facet_wrap(~ Sample_Name) +
  labs(x = 'Time', y = 'Proportion Perceiving Flavor', color = 'Attribute') +
  theme_classic()


```

```{r fig-diff-starch-free, fig.cap="Positive values indicate higher perception in Free Limonene and negative values indicate higher perception in Starch-Limonene IC"}
# Pivot data to calculate the difference
data_diff <- data_summary %>%
  pivot_wider(names_from = Sample_Name, values_from = mean_value) %>%
  mutate(Difference = `Free Limonene` - `Starch-Limonene IC`)

# Plot 
ggplot(data_diff, aes(x = Time, y = Difference, color = Attribute)) +
  geom_line() +
  labs(x = 'Time', y = 'Difference in Perception', color = 'Attribute') +
  theme_classic()

```

```{r}
# Joining the data
combined_data <- data_long %>%
  inner_join(df_saliva, by = "Sample_ID") %>%
  na.omit()
  
```

```{r}
# Categorize gene copy number into two groups: low and high
combined_data_CNV <- combined_data %>% 
  mutate(CNV_group = cut(Primer2_Diploid, breaks = 2, labels = c("Low", "High")))

# Overall proportion perceiving flavor at each time point, by attribute, sample name
flavor_prop_all <- combined_data_CNV %>% 
  group_by(Time, Attribute, Sample_Name) %>%
  summarise(overall_prop = mean(Value), .groups = "drop")

# Proportions perceiving flavor within each CNV group
flavor_prop_CNV <- combined_data_CNV %>% 
  filter(Value == 1) %>%
  group_by(Time, Attribute, Sample_Name, CNV_group) %>%
  summarise(count_flavor = n(), .groups = "drop") %>%
  group_by(Time, Attribute, Sample_Name) %>%
  mutate(proportion_flavor = count_flavor / sum(count_flavor))

# Merge both data frames
final_data <- merge(flavor_prop_all, flavor_prop_CNV, by = c("Time", "Attribute", "Sample_Name"))

# plot
ggplot(final_data, aes(x = Time, y = overall_prop, fill = CNV_group)) +
  geom_col(aes(fill = CNV_group, y = overall_prop * proportion_flavor), position = "stack") +
  facet_grid(Attribute ~ Sample_Name) +
  labs(x = 'Time', y = 'Proportion Perceiving Flavor', fill = 'Copy Number Group')

```

```{r}

# Reshape data to wide format
df_wide1 <- data_long %>%
    pivot_wider(
        names_from = c(Sample_Name, Attribute), 
        values_from = Value,
        names_glue = "{Sample_Name}_{Attribute}"
    )

```

```{r}
samples_to_compare <- c("Free Limonene", "Starch-Limonene IC") 

# Generate difference columns
df_wide_diff <- df_wide1
for (attrib in unique(data_long$Attribute)) {
    df_wide_diff <- df_wide_diff %>%
        mutate(
            !!paste0("Difference_", attrib) :=
                df_wide_diff[[paste0(samples_to_compare[1], "_", attrib)]] - 
                df_wide_diff[[paste0(samples_to_compare[2], "_", attrib)]]
        )
}

df_wide_diff


```

```{r}


df_saliva_filter <- df_saliva %>% 
  mutate(Flow_Rate_mean = (Flow_Rate_1_g_min + Flow_Rate_2_g_min)/2) %>% 
  select(c(Sample_ID, Primer1_Diploid, Primer2_Diploid, sAA_Before, sAA_After, sAA_Change, TP_Before, TP_After, TP_Change, Flow_Rate_mean, Citrus_Sum_120sec)) %>% 
  na.omit()

combined_data_diff <- df_wide_diff %>%
  inner_join(df_saliva_filter, by = "Sample_ID") %>% 
  na.omit(Primer2_Diploid) %>% 
  mutate(CNV_group = if_else(Primer2_Diploid > quantile(Primer2_Diploid, probs = .75), "High", "Low"),
         sAA_After_group = if_else(sAA_After > quantile(sAA_After, probs = .75), "High", "Low"),
         sAA_Change_group = if_else(sAA_Change > quantile(sAA_Change, probs = .75), "High", "Low"),
         sAA_flow_Afterrate = sAA_After*Flow_Rate_mean,
         sAA_flow_After_group = if_else(sAA_flow_Afterrate > quantile(sAA_flow_Afterrate, probs = .75), "High", "Low"))


```


```{r}
plot_perception <- function(data, group_col, group_labels, color_vector = c("blue", "red", "green")) {
  
  # Ensure group column is a factor
  data[[group_col]] <- as.factor(data[[group_col]])

  # Get the name of the group_col variable for use in labels
  group_col_name <- deparse(substitute(group_col))
  
  # Calculate proportions
  data_plot <- data %>%
    gather(key = "Attribute", value = "Difference", starts_with("Difference_")) %>% 
    mutate(Positive_Change = Difference > 0,
           Negative_Change = Difference < 0,
           No_Change = Difference == 0) %>%
    group_by(Attribute, !!sym(group_col), Time) %>%
    summarize(Prop_Positive_Change = mean(Positive_Change),
              Prop_Negative_Change = mean(Negative_Change),
              Prop_No_Change = mean(No_Change), .groups = 'drop') %>%
    pivot_longer(starts_with("Prop_"), names_to = "Change", values_to = "Proportion") 

  # Plot
  ggplot(data_plot, aes(x = Time, y = Proportion, color = !!sym(group_col), linetype = Change)) +
    geom_line() +
    scale_y_continuous(labels = scales::percent) +
    scale_color_manual(values = color_vector, labels = group_labels) +
    scale_linetype_manual(values = c("Prop_Positive_Change" = "solid", "Prop_Negative_Change" = "dashed", "Prop_No_Change" = "dotted")) +
    labs(y = "Proportion of Change in Perception",
         x = "Time",
         color = group_col_name, 
         linetype = "Change Type") +
    theme_minimal() +
    facet_grid(Attribute ~ Change) + 
    ggtitle("Positive, Negative, and No Change in Flavor Perception Over Time")
  
}


```


```{r fig.height=10}
# Use function
plot_perception(combined_data_diff, "CNV_group", c("Low", "High"))

```


```{r fig.height=10}
# Use function
plot_perception(combined_data_diff, "sAA_After_group", c("Low", "High"))


```

```{r fig.height=10}
# Use function
plot_perception(combined_data_diff, "sAA_Change_group", c("Low", "High"))


```

```{r fig.height=10}
# Use function
plot_perception(combined_data_diff, "sAA_flow_After_group", c("Low", "High"))


```

